# アーカイブされた問題と解決策の記録 (Part 2)

## [ISSUE-008] - 2025-02-06
### Requesty API レスポンス解析修正記録
#### 修正内容
- APIリクエスト後、レスポンス全文（response.text）をログ出力するコードを追加し、APIから返却される全レスポンスを確認可能にした。
- JSONパースが失敗した場合、正規表現で抽出されたJSON文字列をログ出力するように変更した。
- 余分な中括弧（}）が存在していた箇所を削除し、文法エラーを解消した。
- 正規表現で抽出されたJSON文字列をログ出力する処理を追加し、抽出結果を確認できるようにした。
#### 検証結果
- 修正は正しくapp.pyに反映され、JSONパースエラーの原因解析に大いに役立っている。
- 追加したログ出力により、抽出されたJSON文字列が確認でき、問題の切り分けが可能になった。
#### 状態
- [x] 実装完了
- [x] 検証完了

## [ISSUE-009] - 2025-02-06
### Requesty APIレスポンス解析修正記録
#### 修正内容
- APIリクエスト後、レスポンス全文（response.text）をログ出力するコードを追加し、APIから返却される全レスポンスを確認可能にした。
- JSONパースが失敗した場合、正規表現で抽出されたJSON文字列をログ出力するように変更した。
- 余分な中括弧（}）が存在していた箇所を削除し、文法エラーを解消した。
- 正規表現で抽出されたJSON文字列をログ出力する処理を追加し、抽出結果を確認できるようにした。
#### 検証結果
- 修正は正しくapp.pyに反映され、JSONパースエラーの原因解析に大いに役立っている。
- 追加したログ出力により、抽出されたJSON文字列が確認でき、問題の切り分けが可能になった。
#### 状態
- [x] 実装完了
- [x] 検証完了

## [ISSUE-010] - 2025-02-06
### エラー原因の包括的分析と検証記録
#### 問題
- Requesty APIから「404 page not found」と「Extra data: line 1 column 5 (char 4)」というエラーが発生している。
#### 可能性のある原因
1. APIエンドポイントの不一致:
   - 使用中のエンドポイント `https://router.requesty.ai/v1` が最新の仕様と合致していない可能性。
2. リクエストペイロードの不整合:
   - 送信されるJSONデータ（url, language, count, model, options）の形式や内容が、API側の仕様と異なっている可能性。
3. 認証情報の誤り:
   - 環境変数 REQUESTY_API_KEY の値が正しくない、または有効期限切れの可能性。
4. Instagram URLの形式の問題:
   - `clean_url`関数による整形は正しく行われているものの、他の形式の問題が存在する可能性。
5. ネットワークその他要因:
   - APIサーバー側で一時的な不具合が発生している、またはネットワーク関連の問題。
#### 対応策および検証計画
1. APIエンドポイントの検証:
   - 最新ドキュメントを再確認し、正しいエンドポイントかテストツール（Postman等）で動作確認。
2. リクエストペイロードの検証:
   - 送信データのログ出力を再確認し、仕様通りに整形されているか検証。
3. 認証情報の再確認:
   - REQUESTY_API_KEY の設定を再確認し、正しい値が使用されているか検証。
4. Instagram URLの再検証:
   - ユニットテスト等で `clean_url`関数の出力を検証し、想定外の形式がないか確認。
5. ネットワークおよびAPIサーバーの状態確認:
   - 他のネットワークツールでAPIサーバーへアクセスし、サーバー側の状態を確認。
#### 状態
- [x] 分析完了
- [x] 対策実施済み

## [ISSUE-011] - 2025-02-06
### デバッグログ強化による問題解析
#### 修正内容
- APIリクエスト送信前に、実際に送信されるURLの詳細な内容を確認するためのデバッグログを追加
- Python の repr() 関数を使用して、URLに含まれる特殊文字や余分な文字を可視化
- URLの文字列長も合わせて出力し、予期しない文字の混入を検出可能に
#### 目的
- clean_url 関数による整形後のURLが、APIリクエスト時に正しい形式で送信されているか確認
- セミコロンなどの余分な文字が完全に除去されているか検証
- URLの長さを監視することで、不正な文字の混入を早期発見
#### 状態
- [x] 実装完了
- [x] 検証完了

## [ISSUE-012] - 2025-02-06
### URL処理とログ出力の包括的改善
#### 問題
- InstagramのURLに含まれる不要なパラメータやセミコロンによりAPIリクエストが失敗
- ログ出力時のJSON形式の問題でデバッグが困難
- URLクリーニング処理が不十分
#### 対応策
1. URLクリーニング処理の強化
   - 正規表現を使用してInstagramの基本URLのみを抽出
   - クエリパラメータを完全に除去する処理を追加
   - 元のURLと処理後のURLの両方をログ出力
2. リクエストパラメータのログ出力改善
   - JSON文字列化を避け、直接オブジェクトをログ出力
   - より詳細なログ形式の実装
   - デバッグ情報の可視性向上
#### 状態
- [x] 実装完了
- [x] 検証完了

## [ISSUE-013] - 2025-02-06
### リクエストデータ構築処理の改善
#### 問題
- リクエストデータにセミコロンが混入し続ける
- JSONデータの検証が不十分
- 404エラーの継続的な発生
#### 原因分析
1. セミコロン混入の原因：
   - clean_url関数でURLの基本部分は抽出できているが
   - リクエストデータ構築時に何らかの形でセミコロンが付加される
2. 404エラーの原因：
   - 不正なJSON形式によりAPIサーバーが正しく処理できない
   - リクエストデータの検証が不十分
#### 実施した修正
1. リクエストデータ構築の改善：
   ```python
   cleaned_url = instagram_url.rstrip(';')  # 末尾のセミコロンを確実に除去
   request_data = {
       'url': cleaned_url,
       # ... その他のパラメータ
   }
   ```
2. JSONデータの検証追加：
   ```python
   # JSONとしての妥当性を検証
   validated_data = json.loads(json.dumps(request_data))
   request_data = validated_data  # 検証済みのデータを使用
   ```
#### 状態
- [x] 実装完了
- [x] 検証完了

## [ISSUE-014] - 2025-02-06
### セミコロン除去処理の包括的な見直し
#### 問題の経緯
1. 当初の対応（ISSUE-007）
   - rstrip(';')による末尾のセミコロン除去
   - 部分的な解決に留まる
2. その後の対応（ISSUE-012）
   - 正規表現によるURL抽出
   - クエリパラメータの除去
   - 完全な解決には至らず
3. 直近の対応（ISSUE-013）
   - rstrip(';')の再実装
   - JSONデータの検証追加
   - 依然として問題が残る
#### 新たな対応策
1. 包括的なセミコロン除去
   ```python
   if ';' in instagram_url:
       logger.warning(f"Semicolon found in URL: {instagram_url}")
       instagram_url = instagram_url.replace(';', '')
       logger.info(f"Removed semicolon from URL: {instagram_url}")
   ```
2. 多層的な検証
   - URL文字列全体でのセミコロンチェック
   - リクエストデータ全体での再チェック
   - 詳細なログ出力による追跡
#### 状態
- [x] 実装完了
- [x] 検証完了