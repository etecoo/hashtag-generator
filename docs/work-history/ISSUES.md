# 問題と解決策の記録

## [ISSUE-001] - 2025-02-05
### Requesty LLM Service統合の考慮事項
#### 問題
- Requesty LLM Serviceの具体的なエンドポイントとパラメータが未確定
- 画像解析とテキスト解析の最適な組み合わせ方法の検討が必要
#### 対応策
1. Requestyのドキュメントを詳細に確認
2. テスト用エンドポイントでの動作確認
3. エラーハンドリングの実装
4. レスポンス形式の標準化
#### 状態
- [ ] 解決待ち
- [ ] テスト実施待ち

## [ISSUE-002] - 2025-02-05
### Instagram URLの取り扱い
#### 問題
- Instagram URLのフォーマットバリデーション
- 非公開アカウントの投稿へのアクセス制限
- 画像取得時の認証要件
#### 対応策
1. URLフォーマットの正規表現パターン作成
2. エラーメッセージの多言語対応
3. アクセス制限時の適切なエラーハンドリング
#### 状態
- [ ] 実装待ち
- [ ] テスト待ち

## [ISSUE-003] - 2025-02-05
### パフォーマンスとスケーラビリティ
#### 問題
- 画像解析時の処理時間
- 同時リクエスト処理の制限
- APIレート制限の管理
#### 対応策
1. キャッシュ戦略の検討
2. 非同期処理の実装
3. レート制限の実装
4. エラー時のフォールバック処理
#### 状態
- [ ] 設計検討中
- [ ] 実装待ち

## [ISSUE-004] - 2025-02-05
### デプロイメント設定
#### 問題
- Railway上での環境変数管理
- 本番環境でのログ管理
- スケーリング設定
#### 対応策
1. 環境変数の整理と設定
2. ログ出力の実装
3. スケーリングポリシーの検討
#### 状態
- [ ] 設定待ち
- [ ] テスト待ち

## [ISSUE-005] - 2025-02-05
### ハッシュタグ生成エラーの対応
#### 問題
- Requesty APIとの通信時にエラーが発生
- エラーメッセージの詳細が不明確
- デバッグ情報の不足
#### 対応策
1. エラーハンドリングの強化
   - APIキーの存在チェックを追加
   - Instagram URLのバリデーション実装
   - Requestyからのエラーメッセージの詳細取得
2. ロギング機能の実装
   - リクエスト情報のログ記録
   - レスポンスステータスのログ記録
   - エラー詳細のログ記録
3. URLバリデーションの追加
   - Instagram投稿URLの形式チェック
   - 必須パラメータの検証
#### 状態
- [x] 実装完了
- [ ] テスト待ち

## [ISSUE-006] - 2025-02-05
### API接続エラーの改善
#### 問題
- "Failed to connect to the API service" エラーの発生
- エラーの詳細情報が不足
- ネットワーク関連の問題の特定が困難
#### 対応策
1. タイムアウト設定の追加
   - 30秒のタイムアウト制限を設定
   - タイムアウト時の明確なエラーメッセージ
2. SSL/ネットワークエラーハンドリング
   - SSL証明書検証の明示的な有効化
   - 接続エラーの詳細なログ記録
   - ユーザーフレンドリーなエラーメッセージ
3. ログ機能の強化
   - エラーの種類ごとの詳細なログ記録
   - トラブルシューティングの容易化
#### 状態
- [x] 実装完了
- [ ] テスト待ち

## [ISSUE-007] - 2025-02-05
### JSONパースエラーの修正
#### 問題
- Instagram URLにセミコロンが含まれることによるJSONパースエラー
- エラーメッセージ: "Extra data: line 1 column 5 (char 4)"
- URLバリデーションの不完全な処理
#### 対応策
1. URLバリデーション処理の強化
   - URLから末尾のセミコロンを除去する処理を追加
   - クエリパラメータを考慮したURLパターンの修正
   - 正規表現パターンの更新
#### 状態
- [x] 実装完了
- [ ] テスト待ち
1. キャッシュ戦略の検討
2. 非同期処理の実装
3. レート制限の実装
4. エラー時のフォールバック処理
#### 状態
- [ ] 設計検討中
- [ ] 実装待ち

## [ISSUE-008] - 2025-02-06
### Requesty API レスポンス解析修正記録 (追記)
修正内容:
- APIリクエスト後、レスポンス全文（response.text）をログ出力するコードを追加し、APIから返却される全レスポンスを確認可能にした。
- JSONパースが失敗した場合、正規表現で抽出されたJSON文字列をログ出力するように変更した。
- 余分な中括弧（}）が存在していた箇所を削除し、文法エラーを解消した。
- 正規表現で抽出されたJSON文字列をログ出力する処理を追加し、抽出結果を確認できるようにした.
検証結果:
- 修正は正しくapp.pyに反映され、JSONパースエラーの原因解析に大いに役立っている。
- 追加したログ出力により、抽出されたJSON文字列が確認でき、問題の切り分けが可能になった.
今後:
- 取得したログ情報をもとに、APIレスポンスの詳細解析および必要な追加改修を実施する.

## [ISSUE-009] - 2025-02-06 Requesty APIレスポンス解析修正記録 (追記)
修正内容:
- APIリクエスト後、レスポンス全文（response.text）をログ出力するコードを追加し、APIから返却される全レスポンスを確認可能にした。
- JSONパースが失敗した場合、正規表現で抽出されたJSON文字列をログ出力するように変更した。
- 余分な中括弧（}）が存在していた箇所を削除し、文法エラーを解消した。
- 正規表現で抽出されたJSON文字列をログ出力する処理を追加し、抽出結果を確認できるようにした.
検証結果:
- 修正は正しくapp.pyに反映され、JSONパースエラーの原因解析に大いに役立っている。
- 追加したログ出力により、抽出されたJSON文字列が確認でき、問題の切り分けが可能になった.
今後:
- 取得したログ情報をもとに、APIレスポンスの詳細解析および必要な追加改修を実施する.

## [ISSUE-010] - 2025-02-06
### エラー原因の包括的分析と検証記録
#### 問題
- Requesty APIから「404 page not found」と「Extra data: line 1 column 5 (char 4)」というエラーが発生している。
#### 可能性のある原因
1. APIエンドポイントの不一致:
   - 使用中のエンドポイント `https://router.requesty.ai/v1` が最新の仕様と合致していない可能性。
2. リクエストペイロードの不整合:
   - 送信されるJSONデータ（url, language, count, model, options）の形式や内容が、API側の仕様と異なっている可能性。
3. 認証情報の誤り:
   - 環境変数 REQUESTY_API_KEY の値が正しくない、または有効期限切れの可能性。
4. Instagram URLの形式の問題:
   - `clean_url`関数による整形は正しく行われているものの、他の形式の問題が存在する可能性。
5. ネットワークその他要因:
   - APIサーバー側で一時的な不具合が発生している、またはネットワーク関連の問題。
#### 対応策および検証計画
1. APIエンドポイントの検証:
   - 最新ドキュメントを再確認し、正しいエンドポイントかテストツール（Postman等）で動作確認。
2. リクエストペイロードの検証:
   - 送信データのログ出力を再確認し、仕様通りに整形されているか検証。
3. 認証情報の再確認:
   - REQUESTY_API_KEY の設定を再確認し、正しい値が使用されているか検証。
4. Instagram URLの再検証:
   - ユニットテスト等で `clean_url`関数の出力を検証し、想定外の形式がないか確認。
5. ネットワークおよびAPIサーバーの状態確認:
   - 他のネットワークツールでAPIサーバーへアクセスし、サーバー側の状態を確認。
#### 状態
- [ ] 各可能性の検証実施待ち
- [ ] 詳細なログおよびテスト結果の収集待ち

## [ISSUE-011] - 2025-02-06
### デバッグログ強化による問題解析
#### 修正内容
- APIリクエスト送信前に、実際に送信されるURLの詳細な内容を確認するためのデバッグログを追加
- Python の repr() 関数を使用して、URLに含まれる特殊文字や余分な文字を可視化
- URLの文字列長も合わせて出力し、予期しない文字の混入を検出可能に

#### 目的
- clean_url 関数による整形後のURLが、APIリクエスト時に正しい形式で送信されているか確認
- セミコロンなどの余分な文字が完全に除去されているか検証
- URLの長さを監視することで、不正な文字の混入を早期発見

#### 期待される効果
- APIリクエスト失敗時の原因特定が容易になる
- URL整形処理の正確性を確認可能
- 今後の改善点の特定がより正確に

#### 状態
- [x] 実装完了
- [x] 動作検証完了

## [ISSUE-012] - 2025-02-06
### URL処理とログ出力の包括的改善
#### 問題
- InstagramのURLに含まれる不要なパラメータやセミコロンによりAPIリクエストが失敗
- ログ出力時のJSON形式の問題でデバッグが困難
- URLクリーニング処理が不十分

#### 対応策
1. URLクリーニング処理の強化
   - 正規表現を使用してInstagramの基本URLのみを抽出
   - クエリパラメータを完全に除去する処理を追加
   - 元のURLと処理後のURLの両方をログ出力

2. リクエストパラメータのログ出力改善
   - JSON文字列化を避け、直接オブジェクトをログ出力
   - より詳細なログ形式の実装
   - デバッグ情報の可視性向上

#### 実装詳細
1. clean_url関数の改善
   ```python
   def clean_url(url):
       base_url_pattern = r'(https?://(?:www\.)?instagram\.com/(?:p|reel)/[\w-]+)/?'
       match = re.match(base_url_pattern, url)
       if not match:
           return ""
       cleaned = match.group(1)
       logger.info(f"Original URL: {url}")
       logger.info(f"Cleaned URL: {cleaned}")
       return cleaned
   ```

2. ログ出力の改善
   ```python
   logger.info("Request parameters:")
   logger.info(request_data)
   logger.info(f"Request URL: {request_data['url']}")
   logger.info(f"URL length: {len(request_data['url'])}")
   ```

#### 期待される効果
- APIリクエストの成功率向上
- デバッグ作業の効率化
- コードの保守性向上

#### 状態
- [x] 実装完了
- [ ] 動作検証待ち

## [ISSUE-013] - 2025-02-06
### リクエストデータ構築処理の改善
#### 問題
- リクエストデータにセミコロンが混入し続ける
- JSONデータの検証が不十分
- 404エラーの継続的な発生

#### 原因分析
1. セミコロン混入の原因：
   - clean_url関数でURLの基本部分は抽出できているが
   - リクエストデータ構築時に何らかの形でセミコロンが付加される

2. 404エラーの原因：
   - 不正なJSON形式によりAPIサーバーが正しく処理できない
   - リクエストデータの検証が不十分

#### 実施した修正
1. リクエストデータ構築の改善：
   ```python
   cleaned_url = instagram_url.rstrip(';')  # 末尾のセミコロンを確実に除去
   request_data = {
       'url': cleaned_url,
       # ... その他のパラメータ
   }
   ```

2. JSONデータの検証追加：
   ```python
   # JSONとしての妥当性を検証
   validated_data = json.loads(json.dumps(request_data))
   request_data = validated_data  # 検証済みのデータを使用
   ```

#### 期待される効果
- セミコロン混入の完全な防止
- 不正なJSONデータの早期検出
- APIリクエストの成功率向上

#### 検証項目
1. セミコロンの除去確認
2. JSONデータの形式確認
3. APIレスポンスの確認

#### 状態
- [x] 実装完了
- [ ] 動作検証待ち

## [ISSUE-015] - 2025-02-06
### フロントエンド・バックエンド間のURL変換問題
#### 問題の発見
1. フロントエンドの動作：
   - 正規表現パターン `(?:\?[^;]*)?$` でセミコロンを含むURLを拒否
   - JSON.stringify で単純にURLを送信
   - 送信時点ではセミコロンは存在しないはず

2. バックエンドの動作：
   - リクエストデータにセミコロンが存在
   - 複数の除去処理を実装するも解決せず

#### 仮説
1. データ転送時の変換問題：
   - フロントエンドからバックエンドへの通信時に何らかの変換が発生
   - Content-Type: application/json の処理過程での問題の可能性

2. フレームワークの動作：
   - FlaskのJSON処理
   - request.get_json()の内部動作

#### 検証計画
1. フロントエンド側の確認：
   - 送信直前のURLの状態をログ出力
   - JSON.stringify後のデータ形式を確認

2. ネットワークレベルの確認：
   - ブラウザの開発者ツールでリクエストの生データを確認
   - 通信途中でのデータ変換の有無を確認

3. バックエンド側の確認：
   - リクエスト受信直後の生データを確認
   - request.get_json()前後のデータ形式を比較

#### 状態
- [ ] 検証開始待ち
- [ ] 原因特定待ち

## [ISSUE-014] - 2025-02-06
### セミコロン除去処理の包括的な見直し
#### 問題の経緯
1. 当初の対応（ISSUE-007）
   - rstrip(';')による末尾のセミコロン除去
   - 部分的な解決に留まる

2. その後の対応（ISSUE-012）
   - 正規表現によるURL抽出
   - クエリパラメータの除去
   - 完全な解決には至らず

3. 直近の対応（ISSUE-013）
   - rstrip(';')の再実装
   - JSONデータの検証追加
   - 依然として問題が残る

#### 新たな対応策
1. 包括的なセミコロン除去
   ```python
   if ';' in instagram_url:
       logger.warning(f"Semicolon found in URL: {instagram_url}")
       instagram_url = instagram_url.replace(';', '')
       logger.info(f"Removed semicolon from URL: {instagram_url}")
   ```

2. 多層的な検証
   - URL文字列全体でのセミコロンチェック
   - リクエストデータ全体での再チェック
   - 詳細なログ出力による追跡

#### 期待される効果
- セミコロンの完全な除去
- 問題の早期発見
- デバッグの容易化

#### 状態
- [x] 実装完了
- [ ] 動作検証待ち

## [ISSUE-016] - 2025-02-06
### セミコロン問題の継続調査状況まとめ
#### これまでの経緯
1. 段階的な対応の流れ：
   - ISSUE-007: 末尾のセミコロン除去（rstrip）
   - ISSUE-012: 正規表現によるURL抽出
   - ISSUE-013: JSONデータの検証追加
   - ISSUE-014: 包括的なセミコロン除去
   - ISSUE-015: フロントエンド・バックエンド間の変換問題調査

2. 実装済みの対策：
   - フロントエンド：
     * URLの正規表現バリデーション
     * UIベースのデバッグ情報表示
     * JSON変換過程の監視
   - バックエンド：
     * リクエストの生データログ
     * JSONパース前後の状態確認
     * 多層的なセミコロン除去

#### 現在の課題
1. 技術的な問題：
   - セミコロンが依然として混入
   - 404エラーが継続
   - JSONパースエラーが発生

2. 調査の必要な点：
   - フロントエンド→バックエンド間のデータ変換過程
   - Flaskのリクエスト処理メカニズム
   - Instagram URLの特性（意図的なセミコロン付加の可能性）

#### 次のステップ
1. 検証項目：
   - フロントエンドのUIデバッグ表示の確認
   - バックエンドの詳細ログの分析
   - ネットワークレベルのリクエスト確認

2. 追加調査が必要な点：
   - Instagram URLのコピー時の挙動
   - FlaskのJSON処理の詳細
   - ブラウザ拡張機能の影響

#### 参考情報
- 関連コミット：
  * 9d99a75: UIベースのデバッグ情報表示
  * acb5438: バックエンドログ強化
  * d6bdd9f: URL検証改善
#### 状態
- [ ] 新規タスクでの継続調査待ち

## [ISSUE-017] - 2025-02-06
### JSONパース時のセミコロン混入問題の特定
#### 問題の特定
1. データの流れ：
   ```
   フロントエンド送信データ:
   { "url": "https://www.instagram.com/p/DFkiqqsvq98/", "language": "ja", "count": 10 }

   バックエンド受信時の生データ:
   {"url":"https://www.instagram.com/p/DFkiqqsvq98/","language":"ja","count":10}

   JSONパース後のデータ:
   {'url': 'https://www.instagram.com/p/DFkiqqsvq98/';, 'language': 'ja', 'count': 10}
   ```

2. 重要な発見：
   - フロントエンド送信時：セミコロンなし
   - バックエンド受信時の生データ：セミコロンなし
   - JSONパース後：セミコロンが付加
   - 問題はFlaskのrequest.get_json()の内部処理で発生している可能性が高い

#### 仮説
1. Flask の request.get_json() の内部処理で変換が発生
   - JSONデコード時の文字列処理
   - Pythonオブジェクトへの変換過程

2. 対応方針：
   - request.get_json()を使用せず、生データを直接処理
   - 別のJSONパーサーの使用を検討
   - カスタムデコード処理の実装

#### 検証計画
1. 代替手段の実装：
   ```python
   raw_data = request.get_data(as_text=True)
   data = json.loads(raw_data)
   ```

2. デコード処理の検証：
   - 各段階でのデータ形式を確認
   - セミコロン混入のタイミングを特定
   - 文字エンコーディングの影響を確認

#### 状態
- [ ] 検証開始待ち

## [ISSUE-018] - 2025-02-06
### request.get_json()の代替実装による問題解決
#### 問題の背景
- ISSUE-017で特定されたFlaskのrequest.get_json()処理に起因する問題
- JSONパース時にセミコロンが混入する現象

#### 実装した修正
1. データ取得方法の変更：
   ```python
   # 変更前
   data = request.get_json()
   
   # 変更後
   raw_data = request.get_data(as_text=True)
   data = json.loads(raw_data)
   ```

2. 詳細なログ出力の追加：
   - パース前の生データの内容と型を記録
   - パース後のデータ構造を確認
   - セミコロンの存在チェックを実装

3. エラーハンドリングの強化：
   - 空データのチェック
   - JSONDecodeErrorの詳細なログ記録
   - セミコロン検出時の明示的なエラー処理

#### 期待される効果
- セミコロン混入問題の解消
- デバッグ情報の充実
- エラー発生時の原因特定の容易化

#### 検証項目
1. リクエストデータの正常なパース
2. セミコロンを含むデータの適切な処理
3. エラー時のログ出力確認

#### 状態
- [x] 実装完了
- [ ] 動作検証待ち

## [ISSUE-019] - 2025-02-06
### フロントエンド・バックエンド間の通信改善
#### 問題の背景
- レスポンスデータの処理が不完全
- デバッグ情報の表示が一時的な実装
- エラーハンドリングの強化が必要

#### 実装した修正
1. レスポンス処理の改善：
   ```javascript
   // 変更前
   if (response.ok) {
       hashtagsContainer.innerHTML = data.hashtags...
   }
   
   // 変更後
   const data = await response.json();
   if (response.ok && data.hashtags && Array.isArray(data.hashtags)) {
       hashtagsContainer.innerHTML = data.hashtags...
   }
   ```

2. デバッグ情報の強化：
   - リクエスト送信前のデータ検証
   - レスポンスステータスとデータの表示
   - セミコロン検出の警告表示

3. エラーハンドリングの改善：
   - レスポンスデータの型チェック
   - より詳細なエラーメッセージ
   - エラー状態の視覚的フィードバック

#### 期待される効果
- データ処理の信頼性向上
- デバッグ作業の効率化
- ユーザーへのフィードバック改善

#### 検証項目
1. レスポンスデータの正常な処理
2. デバッグ情報の適切な表示
3. エラー時の適切なフィードバック

#### 状態
- [x] 実装完了
- [ ] 動作検証待ち
